:{$PORT} {
  # Security headers
  header {
    # Basic security headers
    X-Content-Type-Options nosniff
    X-Frame-Options DENY
  Referrer-Policy strict-origin-when-cross-origin
  Content-Security-Policy "default-src 'self'; img-src 'self' data: https: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' blob:; font-src 'self' data:; connect-src 'self' https:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'"
  Permissions-Policy "geolocation=(), camera=(), microphone=(), usb=(), payment=()"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  }

  # Serve static files
  root * /srv
  file_server

  # Gzip/Brotli
  encode gzip zstd

  # Cache control for immutable assets
  @immutable {
    path "/_astro/*" "/~partytown/*"
  }
  header @immutable Cache-Control "public, max-age=31536000, immutable"

  # Default cache
  header Cache-Control "public, max-age=3600"

  # Try clean URLs first, then fallback
  try_files {path} {path}/ /index.html
}
